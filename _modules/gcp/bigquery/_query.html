

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gcp.bigquery._query &mdash; Google Cloud Datalab  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Google Cloud Datalab  documentation" href="../../../index.html"/>
        <link rel="up" title="gcp.bigquery" href="../bigquery.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Google Cloud Datalab
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gcp.html">gcp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gcp.bigquery.html">gcp.bigquery package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gcp.data.html">gcp.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gcp.storage.html">gcp.storage package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Google Cloud Datalab</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../bigquery.html">gcp.bigquery</a> &raquo;</li>
      
    <li>gcp.bigquery._query</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gcp.bigquery._query</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2015 Google Inc. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except</span>
<span class="c1"># in compliance with the License. You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software distributed under the License</span>
<span class="c1"># is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express</span>
<span class="c1"># or implied. See the License for the specific language governing permissions and limitations under</span>
<span class="c1"># the License.</span>

<span class="sd">&quot;&quot;&quot;Implements Query BigQuery API.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">gcp._util</span>
<span class="kn">import</span> <span class="nn">gcp.data</span>
<span class="kn">import</span> <span class="nn">_api</span>
<span class="kn">import</span> <span class="nn">_federated_table</span>
<span class="kn">import</span> <span class="nn">_sampling</span>
<span class="kn">import</span> <span class="nn">_udf</span>
<span class="kn">import</span> <span class="nn">_utils</span>


<div class="viewcode-block" id="Query"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query">[docs]</a><span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Represents a Query object that encapsulates a BigQuery SQL query.</span>

<span class="sd">  This object can be used to execute SQL queries and retrieve results.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Query.sampling_query"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.sampling_query">[docs]</a>  <span class="k">def</span> <span class="nf">sampling_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">udfs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">data_sources</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a sampling Query for the SQL object.</span>

<span class="sd">    Args:</span>
<span class="sd">      sql: the SQL statement (string) or Query object to sample.</span>
<span class="sd">      context: a Context object providing project_id and credentials.</span>
<span class="sd">      fields: an optional list of field names to retrieve.</span>
<span class="sd">      count: an optional count of rows to retrieve which is used if a specific</span>
<span class="sd">          sampling is not specified.</span>
<span class="sd">      sampling: an optional sampling strategy to apply to the table.</span>
<span class="sd">      udfs: array of UDFs referenced in the SQL.</span>
<span class="sd">      data_sources: dictionary of federated (external) tables referenced in the SQL.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Query object for sampling the table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="n">_sampling</span><span class="o">.</span><span class="n">Sampling</span><span class="o">.</span><span class="n">sampling_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sampling</span><span class="p">),</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                 <span class="n">udfs</span><span class="o">=</span><span class="n">udfs</span><span class="p">,</span> <span class="n">data_sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">udfs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_sources</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes an instance of a Query object.</span>
<span class="sd">       Note that either values or kwargs may be used, but not both.</span>

<span class="sd">    Args:</span>
<span class="sd">      sql: the BigQuery SQL query string to execute, or a SqlStatement object. The latter will</span>
<span class="sd">          have any variable references replaced before being associated with the Query (i.e.</span>
<span class="sd">          once constructed the SQL associated with a Query is static).</span>

<span class="sd">          It is possible to have variable references in a query string too provided the variables</span>
<span class="sd">          are passed as keyword arguments to this constructor.</span>

<span class="sd">      context: an optional Context object providing project_id and credentials. If a specific</span>
<span class="sd">          project id or credentials are unspecified, the default ones configured at the global</span>
<span class="sd">          level are used.</span>
<span class="sd">      values: a dictionary used to expand variables if passed a SqlStatement or a string with</span>
<span class="sd">          variable references.</span>
<span class="sd">      udfs: array of UDFs referenced in the SQL.</span>
<span class="sd">      data_sources: dictionary of federated (external) tables referenced in the SQL.</span>
<span class="sd">      kwargs: arguments to use when expanding the variables if passed a SqlStatement</span>
<span class="sd">          or a string with variable references.</span>

<span class="sd">    Raises:</span>
<span class="sd">      Exception if expansion of any variables failed.</span>
<span class="sd">      &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">context</span> <span class="o">=</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="n">_api</span><span class="o">.</span><span class="n">Api</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span> <span class="o">=</span> <span class="n">data_sources</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_udfs</span> <span class="o">=</span> <span class="n">udfs</span>

    <span class="k">if</span> <span class="n">data_sources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">data_sources</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_imports</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">values</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="n">gcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">SqlModule</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">udfs</span><span class="p">)</span>

    <span class="c1"># We need to take care not to include the same UDF code twice so we use sets.</span>
    <span class="n">udfs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">udfs</span> <span class="k">if</span> <span class="n">udfs</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_udf</span><span class="o">.</span><span class="n">UDF</span><span class="p">):</span>
        <span class="n">udfs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">included_udfs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">gcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">)</span>
    <span class="n">udf_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">udf</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">udf</span> <span class="k">for</span> <span class="n">udf</span> <span class="ow">in</span> <span class="n">udfs</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
      <span class="c1"># Find the preceding and following non-whitespace tokens</span>
      <span class="n">prior</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">while</span> <span class="n">prior</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="n">prior</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
        <span class="n">prior</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">prior</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="nb">next</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">while</span> <span class="nb">next</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="nb">next</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
        <span class="nb">next</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nb">next</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">uprior</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">prior</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">uprior</span> <span class="o">!=</span> <span class="s1">&#39;FROM&#39;</span> <span class="ow">and</span> <span class="n">uprior</span> <span class="o">!=</span> <span class="s1">&#39;JOIN&#39;</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="c1"># Check for external tables.</span>
      <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="nb">next</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;[(&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_sources</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">token</span><span class="p">],</span> <span class="n">_federated_table</span><span class="o">.</span><span class="n">FederatedTable</span><span class="p">):</span>
              <span class="n">data_sources</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>

      <span class="c1"># Now check for UDF calls.</span>
      <span class="k">if</span> <span class="n">uprior</span> <span class="o">!=</span> <span class="s1">&#39;FROM&#39;</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="nb">next</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="c1"># We have a &#39;FROM token (&#39; sequence.</span>

      <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">udf_dict</span><span class="p">:</span>
        <span class="n">udf</span> <span class="o">=</span> <span class="n">udf_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">included_udfs</span><span class="p">:</span>
          <span class="n">included_udfs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">udf</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">udf</span><span class="o">.</span><span class="n">imports</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imports</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">udf</span><span class="o">.</span><span class="n">imports</span><span class="p">)</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">udf</span><span class="o">.</span><span class="n">_outputs</span><span class="p">])</span>
        <span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(SELECT </span><span class="si">%s</span><span class="s1"> FROM </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

        <span class="c1"># Find the closing parenthesis and add the additional one now needed.</span>
        <span class="n">num_paren</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">num_paren</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
            <span class="n">num_paren</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_paren</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;))&#39;</span>
              <span class="k">break</span>
          <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_external_tables</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_sources</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_external_tables</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">data_sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Referenced external table </span><span class="si">%s</span><span class="s1"> has no known schema&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_external_tables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_to_query_json</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_repr_sql_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a SQL representation of this object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The SQL representation to use when embedding this object into other SQL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span>

<div class="viewcode-block" id="Query.__str__"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.__str__">[docs]</a>  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a string representation of this object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The string representation of this object (the unmodified SQL).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span></div>

<div class="viewcode-block" id="Query.__repr__"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.__repr__">[docs]</a>  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a friendly representation of this object.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The friendly representation of this object (the unmodified SQL).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the SQL for the query. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the code for any Javascript UDFs used in the query. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span>

<div class="viewcode-block" id="Query.results"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.results">[docs]</a>  <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves table of results for the query. May block if the query must be executed first.</span>

<span class="sd">    Args:</span>
<span class="sd">      use_cache: whether to use cached results or not. Ignored if append is specified.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A QueryResultsTable containing the result set.</span>
<span class="sd">    Raises:</span>
<span class="sd">      Exception if the query could not be executed or query response was malformed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_cache</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">results</span></div>

<div class="viewcode-block" id="Query.extract"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.extract">[docs]</a>  <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_uris</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">csv_delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">csv_header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">compress</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exports the query results to GCS.</span>

<span class="sd">    Args:</span>
<span class="sd">      storage_uris: the destination URI(s). Can be a single URI or a list.</span>
<span class="sd">      format: the format to use for the exported data; one of &#39;csv&#39;, &#39;json&#39;, or &#39;avro&#39;</span>
<span class="sd">          (default &#39;csv&#39;).</span>
<span class="sd">      csv_delimiter: for csv exports, the field delimiter to use (default &#39;,&#39;).</span>
<span class="sd">      csv_header: for csv exports, whether to include an initial header line (default True).</span>
<span class="sd">      compress whether to compress the data on export. Compression is not supported for</span>
<span class="sd">          AVRO format (default False).</span>
<span class="sd">      use_cache: whether to use cached results or not (default True).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Job object for the export Job if it was completed successfully; else None.</span>
<span class="sd">    Raises:</span>
<span class="sd">      An Exception if the query or extract failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">storage_uris</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span>
                                                     <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span>
                                                     <span class="n">csv_header</span><span class="o">=</span><span class="n">csv_header</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">)</span></div>

  <span class="nd">@gcp._util.async_method</span>
<div class="viewcode-block" id="Query.extract_async"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.extract_async">[docs]</a>  <span class="k">def</span> <span class="nf">extract_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_uris</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">csv_delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
                    <span class="n">csv_header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exports the query results to GCS. Returns a Job immediately.</span>

<span class="sd">    Note that there are two jobs that may need to be run sequentially, one to run the query,</span>
<span class="sd">    and the second to extract the resulting table. These are wrapped by a single outer Job.</span>

<span class="sd">    If the query has already been executed and you would prefer to get a Job just for the</span>
<span class="sd">    extract, you can can call extract_async on the QueryResultsTable instead; i.e.:</span>

<span class="sd">        query.results().extract_async(...)</span>

<span class="sd">    Args:</span>
<span class="sd">      storage_uris: the destination URI(s). Can be a single URI or a list.</span>
<span class="sd">      format: the format to use for the exported data; one of &#39;csv&#39;, &#39;json&#39;, or &#39;avro&#39;</span>
<span class="sd">          (default &#39;csv&#39;).</span>
<span class="sd">      csv_delimiter: for CSV exports, the field delimiter to use (default &#39;,&#39;).</span>
<span class="sd">      csv_header: for CSV exports, whether to include an initial header line (default True).</span>
<span class="sd">      compress whether to compress the data on export. Compression is not supported for</span>
<span class="sd">          AVRO format (default False).</span>
<span class="sd">      use_cache: whether to use cached results or not (default True).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Job for the combined (execute, extract) task that will in turn return the Job object for</span>
<span class="sd">      the completed extract task when done; else None.</span>
<span class="sd">    Raises:</span>
<span class="sd">      An Exception if the query failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">storage_uris</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span>
                        <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span> <span class="n">csv_header</span><span class="o">=</span><span class="n">csv_header</span><span class="p">,</span>
                        <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.to_dataframe"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.to_dataframe">[docs]</a>  <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Exports the query results to a Pandas dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">      start_row: the row of the table at which to start the export (default 0).</span>
<span class="sd">      max_rows: an upper limit on the number of rows to export (default None).</span>
<span class="sd">      use_cache: whether to use cached results or not (default True).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Pandas dataframe containing the table data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">start_row</span><span class="o">=</span><span class="n">start_row</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="n">max_rows</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.to_file"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.to_file">[docs]</a>  <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">csv_delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">csv_header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the results to a local file in CSV format.</span>

<span class="sd">    Args:</span>
<span class="sd">      path: path on the local filesystem for the saved results.</span>
<span class="sd">      format: the format to use for the exported data; currently only &#39;csv&#39; is supported.</span>
<span class="sd">      csv_delimiter: for CSV exports, the field delimiter to use. Defaults to &#39;,&#39;</span>
<span class="sd">      csv_header: for CSV exports, whether to include an initial header line. Default true.</span>
<span class="sd">      use_cache: whether to use cached results or not.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The path to the local file.</span>
<span class="sd">    Raises:</span>
<span class="sd">      An Exception if the operation failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span> <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span> <span class="n">csv_header</span><span class="o">=</span><span class="n">csv_header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span></div>

  <span class="nd">@gcp._util.async_method</span>
<div class="viewcode-block" id="Query.to_file_async"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.to_file_async">[docs]</a>  <span class="k">def</span> <span class="nf">to_file_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">csv_delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">csv_header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the results to a local file in CSV format. Returns a Job immediately.</span>

<span class="sd">    Args:</span>
<span class="sd">      path: path on the local filesystem for the saved results.</span>
<span class="sd">      format: the format to use for the exported data; currently only &#39;csv&#39; is supported.</span>
<span class="sd">      csv_delimiter: for CSV exports, the field delimiter to use. Defaults to &#39;,&#39;</span>
<span class="sd">      csv_header: for CSV exports, whether to include an initial header line. Default true.</span>
<span class="sd">      use_cache: whether to use cached results or not.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Job for the save that returns the path to the local file on completion.</span>
<span class="sd">    Raises:</span>
<span class="sd">      An Exception if the operation failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span> <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span> <span class="n">csv_header</span><span class="o">=</span><span class="n">csv_header</span><span class="p">,</span>
                        <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.sample"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.sample">[docs]</a>  <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a sampling of rows for the query.</span>

<span class="sd">    Args:</span>
<span class="sd">      count: an optional count of rows to retrieve which is used if a specific</span>
<span class="sd">          sampling is not specified (default 5).</span>
<span class="sd">      fields: the list of fields to sample (default None implies all).</span>
<span class="sd">      sampling: an optional sampling strategy to apply to the table.</span>
<span class="sd">      use_cache: whether to use cached results or not (default True).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A QueryResultsTable containing a sampling of the result set.</span>
<span class="sd">    Raises:</span>
<span class="sd">      Exception if the query could not be executed or query response was malformed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Query</span><span class="o">.</span><span class="n">sampling_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                                <span class="n">sampling</span><span class="o">=</span><span class="n">sampling</span><span class="p">,</span> <span class="n">udfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_udfs</span><span class="p">,</span>
                                <span class="n">data_sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span><span class="p">)</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.execute_dry_run"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.execute_dry_run">[docs]</a>  <span class="k">def</span> <span class="nf">execute_dry_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dry run a query, to check the validity of the query and return some useful statistics.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A dict with &#39;cacheHit&#39; and &#39;totalBytesProcessed&#39; fields.</span>
<span class="sd">    Raises:</span>
<span class="sd">      An exception if the query was malformed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">jobs_insert_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imports</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                 <span class="n">table_definitions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_tables</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">query_result</span><span class="p">[</span><span class="s1">&#39;statistics&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Query.execute_async"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.execute_async">[docs]</a>  <span class="k">def</span> <span class="nf">execute_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">table_mode</span><span class="o">=</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span> <span class="n">allow_large_results</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Initiate the query and return a QueryJob.</span>

<span class="sd">    Args:</span>
<span class="sd">      dataset_id: the datasetId for the result table.</span>
<span class="sd">      table_name: the result table name as a string or TableName; if None (the default), then a</span>
<span class="sd">          temporary table will be used.</span>
<span class="sd">      table_mode: one of &#39;create&#39;, &#39;overwrite&#39; or &#39;append&#39;. If &#39;create&#39; (the default), the request</span>
<span class="sd">          will fail if the table exists.</span>
<span class="sd">      use_cache: whether to use past query results or ignore cache. Has no effect if destination is</span>
<span class="sd">          specified (default True).</span>
<span class="sd">      priority:one of &#39;batch&#39; or &#39;interactive&#39; (default). &#39;interactive&#39; jobs should be scheduled</span>
<span class="sd">          to run quickly but are subject to rate limits; &#39;batch&#39; jobs could be delayed by as much</span>
<span class="sd">          as three hours but are not rate-limited.</span>
<span class="sd">      allow_large_results: whether to allow large results; i.e. compressed data over 100MB. This is</span>
<span class="sd">          slower and requires a table_name to be specified) (default False).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A QueryJob.</span>
<span class="sd">    Raises:</span>
<span class="sd">      Exception if query could not be executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span>
    <span class="n">append</span> <span class="o">=</span> <span class="n">table_mode</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">table_mode</span> <span class="o">==</span> <span class="s1">&#39;overwrite&#39;</span>
    <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">table_name</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">parse_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">jobs_insert_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imports</span><span class="p">,</span>
                                                 <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                                                 <span class="n">append</span><span class="o">=</span><span class="n">append</span><span class="p">,</span>
                                                 <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                                                 <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
                                                 <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                                                 <span class="n">allow_large_results</span><span class="o">=</span><span class="n">allow_large_results</span><span class="p">,</span>
                                                 <span class="n">table_definitions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_tables</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="s1">&#39;jobReference&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_result</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected response from server&#39;</span><span class="p">)</span>

    <span class="n">job_id</span> <span class="o">=</span> <span class="n">query_result</span><span class="p">[</span><span class="s1">&#39;jobReference&#39;</span><span class="p">][</span><span class="s1">&#39;jobId&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">destination</span> <span class="o">=</span> <span class="n">query_result</span><span class="p">[</span><span class="s1">&#39;configuration&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;destinationTable&#39;</span><span class="p">]</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">destination</span><span class="p">[</span><span class="s1">&#39;projectId&#39;</span><span class="p">],</span> <span class="n">destination</span><span class="p">[</span><span class="s1">&#39;datasetId&#39;</span><span class="p">],</span> <span class="n">destination</span><span class="p">[</span><span class="s1">&#39;tableId&#39;</span><span class="p">])</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># The query was in error</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_utils</span><span class="o">.</span><span class="n">format_query_errors</span><span class="p">(</span><span class="n">query_result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">_query_job</span><span class="o">.</span><span class="n">QueryJob</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.execute"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.execute">[docs]</a>  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">table_mode</span><span class="o">=</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span>
              <span class="n">allow_large_results</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Initiate the query, blocking until complete and then return the results.</span>

<span class="sd">    Args:</span>
<span class="sd">      table_name: the result table name as a string or TableName; if None (the default), then a</span>
<span class="sd">          temporary table will be used.</span>
<span class="sd">      table_mode: one of &#39;create&#39;, &#39;overwrite&#39; or &#39;append&#39;. If &#39;create&#39; (the default), the request</span>
<span class="sd">          will fail if the table exists.</span>
<span class="sd">      use_cache: whether to use past query results or ignore cache. Has no effect if destination is</span>
<span class="sd">          specified (default True).</span>
<span class="sd">      priority:one of &#39;batch&#39; or &#39;interactive&#39; (default). &#39;interactive&#39; jobs should be scheduled</span>
<span class="sd">          to run quickly but are subject to rate limits; &#39;batch&#39; jobs could be delayed by as much</span>
<span class="sd">          as three hours but are not rate-limited.</span>
<span class="sd">      allow_large_results: whether to allow large results; i.e. compressed data over 100MB. This is</span>
<span class="sd">          slower and requires a table_name to be specified) (default False).</span>
<span class="sd">    Returns:</span>
<span class="sd">      The QueryResultsTable for the query.</span>
<span class="sd">    Raises:</span>
<span class="sd">      Exception if query could not be executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_async</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_mode</span><span class="o">=</span><span class="n">table_mode</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
                             <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span> <span class="n">allow_large_results</span><span class="o">=</span><span class="n">allow_large_results</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span></div>

<div class="viewcode-block" id="Query.to_view"><a class="viewcode-back" href="../../../gcp.bigquery.html#gcp.bigquery.Query.to_view">[docs]</a>  <span class="k">def</span> <span class="nf">to_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a View from this Query.</span>

<span class="sd">    Args:</span>
<span class="sd">      view_name: the name of the View either as a string or a 3-part tuple</span>
<span class="sd">          (projectid, datasetid, name).</span>

<span class="sd">    Returns:</span>
<span class="sd">      A View for the Query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_view</span><span class="o">.</span><span class="n">View</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">)</span></div></div>

<span class="kn">import</span> <span class="nn">_query_job</span>
<span class="kn">import</span> <span class="nn">_view</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Google, Inc..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>